#!/usr/bin/env bash

{{- if .desktop }}

[[ -d "$udevPath" ]] || sudo install -d -m 0755 "$udevPath"

set_udev() {
  local install=0
  local udevPath="/etc/udev/rules.d"
  local udevSnack="$udevPath/99-snackbox-controllers.rules"
  local udevDualctl="$udevPath/98-dualsensectl.rules"
  local udevDs5="$udevPath/99-ignore-ds5-touchpad.rules"
  local udevVia="$udevPath/92-viia.rules"
  
  if [[ ! -f "$udevSnack" ]]; then 
    echo -e "{{ .color.bold }}Info{{ .color.reset }}: {{ .color.info }}setting up udev rules...{{ .color.reset }}{{ .icon.info }}"
    sudo tee "$udevSnack" > /dev/null <<'EOF'
# udev rules for Snackbox Micro (Zeroplus-based)
KERNEL=="hidraw*", ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox", MODE="0660", TAG+="uaccess"

KERNEL=="event*",  ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox-event", MODE="0660", TAG+="uaccess"
EOF
  install=1
  fi

  if [[ ! -f "$udevDualctl" ]]; then
    echo -e "{{ .color.bold }}Info{{ .color.reset }}: {{ .color.info }}setting up udev rules...{{ .color.reset }}{{ .icon.info }}"
    sudo tee "$udevDualctl" > /dev/null <<'EOF'
# PS5 DualSense controller over USB hidraw
KERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0ce6", MODE="0660", TAG+="uaccess"

# PS5 DualSense controller over bluetooth hidraw
KERNEL=="hidraw*", KERNELS=="*054C:0CE6*", MODE="0660", TAG+="uaccess"

# PS5 DualSense Edge controller over USB hidraw
KERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0df2", MODE="0660", TAG+="uaccess"

# PS5 DualSense Edge controller over bluetooth hidraw
KERNEL=="hidraw*", KERNELS=="*054C:0DF2*", MODE="0660", TAG+="uaccess"
EOF
  install=1
  fi

  if [[ ! -f "$udevDs5" ]]; then
    echo -e "{{ .color.bold }}Info{{ .color.reset }}: {{ .color.info }}setting up udev rules...{{ .color.reset }}{{ .icon.info }}"
    sudo tee "$udevDs5" > /dev/null <<'EOF'
# USB touchpad ignore
ACTION=="add|change", ATTRS{name}=="Sony Interactive Entertainment DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"

# BT touchpad ignore
ACTION=="add|change", ATTRS{name}=="DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
EOF
  install=1
  fi

  if [[ ! -f "$udevVia" ]]; then
    echo -e "{{ .color.bold }}Info{{ .color.reset }}: {{ .color.info }}setting up udev rules...{{ .color.reset }}{{ .icon.info }}"
    sudo tee "$udevVia" > /dev/null <<'EOF'
KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0666", TAG+="uaccess", TAG+="udev-acl"
EOF
  install=1
  fi
  
  sudo chmod 0644 "$udevSnack" "$udevDualctl" "$udevDs5" "$udevVia"
  
  [[ "$install" -eq 0 ]] && echo -e "{{ .color.bold }}Info{{ .color.reset }}: {{ .color.info }}udev rules already setup..{{ .color.reset }}{{ .icon.info }}"
  
  sudo udevadm control --reload-rules
  sudo udevadm trigger
}

prompt_udev() {
  local response
  echo -e "{{ .color.bold }}Prompt{{ .color.reset }}: {{ .color.info }}would you like setup udev rules for gaming?[Y/n]...{{ .color.reset }}{{ .icon.info }}"
  read -rp "response: " response
  response="${response,,}"
  case "$response" in
    n | no)
      echo -e "{{ .color.bold }}Warning{{ .color.reset }}: {{ .color.warning }}skipping udev rules setup...{{ .color.reset }}{{ .icon.warning }}"
      ;;
    y | yes | "")
      set_udev
      ;;
    *)
      echo -e "{{ .color.bold }}Error{{ .color.reset }}: {{ .color.error }}invalid response '$response', it's a simple yes or no...{{ .color.reset }}{{ .icon.error }}"
      prompt_udev
      ;;
  esac
}

prompt_udev

{{ end -}}
