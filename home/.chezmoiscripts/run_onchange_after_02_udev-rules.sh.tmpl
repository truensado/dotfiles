#!/usr/bin/env bash

{{- if .desktop }}

scrDir={{ .chezmoi.sourceDir }}/.chezmoiscripts/lib
source "$scrDir/colors.sh"
source "$scrDir/paths.sh"
source "$scrDir/vars.sh"

[[ -d "$udevPath" ]] || sudo install -d -m 0755 "$udevPath"

set_udev() {
  local install=0
  
  if [[ ! -f "$udevSnack" ]]; then 
    echo -e "${bold}Info${reset}: ${info}setting up udev rules...${reset}${iinfo}"
    sudo tee "$udevSnack" > /dev/null <<'EOF'
# udev rules for Snackbox Micro (Zeroplus-based)
KERNEL=="hidraw*", ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox", MODE="0660", TAG+="uaccess"

KERNEL=="event*",  ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox-event", MODE="0660", TAG+="uaccess"
EOF
  install=1
  fi

  if [[ ! -f "$udevDualctl" ]]; then
    echo -e "${bold}Info${reset}: ${info}setting up udev rules...${reset}${iinfo}"
    sudo tee "$udevDualctl" > /dev/null <<'EOF'
# PS5 DualSense controller over USB hidraw
KERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0ce6", MODE="0660", TAG+="uaccess"

# PS5 DualSense controller over bluetooth hidraw
KERNEL=="hidraw*", KERNELS=="*054C:0CE6*", MODE="0660", TAG+="uaccess"

# PS5 DualSense Edge controller over USB hidraw
KERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0df2", MODE="0660", TAG+="uaccess"

# PS5 DualSense Edge controller over bluetooth hidraw
KERNEL=="hidraw*", KERNELS=="*054C:0DF2*", MODE="0660", TAG+="uaccess"
EOF
  install=1
  fi

  if [[ ! -f "$udevDs5" ]]; then
    echo -e "${bold}Info${reset}: ${info}setting up udev rules...${reset}${iinfo}"
    sudo tee "$udevDs5" > /dev/null <<'EOF'
# USB touchpad ignore
ACTION=="add|change", ATTRS{name}=="Sony Interactive Entertainment DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"

# BT touchpad ignore
ACTION=="add|change", ATTRS{name}=="DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
EOF
  install=1
  fi

  if [[ ! -f "$udevVia" ]]; then
    echo -e "${bold}Info${reset}: ${info}setting up udev rules...${reset}${iinfo}"
    sudo tee "$udevVia" > /dev/null <<'EOF'
KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0666", TAG+="uaccess", TAG+="udev-acl"
EOF
  install=1
  fi
  
  sudo chmod 0644 "$udevSnack" "$udevDualctl" "$udevDs5" "$udevVia"
  
  [[ "$install" -eq 0 ]] && echo -e "${bold}Info${reset}: ${info}udev rules already setup..${reset}${iinfo}"
  
  sudo udevadm control --reload-rules
  sudo udevadm trigger
}

prompt_udev() {
  local response
  read -rp "${bold}Prompt${reset}: ${info}would you like setup udev rules for gaming?[Y/n]...${reset}${iinfo}" response
  response="${response,,}"
  case "$response" in
    n | no)
      echo -e "${bold}Warning${reset}: ${warning}skipping udev rules setup...${reset}${iwarning}"
      ;;
    y | yes | "")
      set_udev
      ;;
    *)
      echo -e "${bold}Error${reset}: ${error}invalid response '$response', it's a simple yes or no...${reset}${ierror}"
      prompt_udev
      ;;
  esac
}

prompt_udev

{{ end -}}
