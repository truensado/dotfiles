#!/usr/bin/env bash

{{- if .desktop }}

path="/etc/udev/rules.d"

[[ -d "$path" ]] || sudo install -d -m 0755 "$path"

set_udev() {
  local snack99="$path/99-snackbox-controllers.rules"
  local dualctl98="$path/98-dualsensectl.rules"
  local ignoreTouch99="$path/99-ignore-ds5-touchpad.rules"
  local via92="$path/92-viia.rules"

  if ! [[ -f "$snack99" ]]; then
    sudo tee "$snack99" > /dev/null <<'EOF'
# udev rules for Snackbox Micro (Zeroplus-based)
KERNEL=="hidraw*", ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox", MODE="0660", TAG+="uaccess"

KERNEL=="event*",  ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox-event", MODE="0660", TAG+="uaccess"
EOF
  fi

  if ! [[ -f "$dualctl98" ]]; then
    sudo tee "$dualctl98" > /dev/null <<'EOF'
# PS5 DualSense controller over USB hidraw
KERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0ce6", MODE="0660", TAG+="uaccess"

# PS5 DualSense controller over bluetooth hidraw
KERNEL=="hidraw*", KERNELS=="*054C:0CE6*", MODE="0660", TAG+="uaccess"

# PS5 DualSense Edge controller over USB hidraw
KERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0df2", MODE="0660", TAG+="uaccess"

# PS5 DualSense Edge controller over bluetooth hidraw
KERNEL=="hidraw*", KERNELS=="*054C:0DF2*", MODE="0660", TAG+="uaccess"
EOF
  fi

  if ! [[ -f "$ignoreTouch99" ]]; then
    sudo tee "$ignoreTouch99" > /dev/null <<'EOF'
# USB touchpad ignore
ACTION=="add|change", ATTRS{name}=="Sony Interactive Entertainment DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"

# BT touchpad ignore
ACTION=="add|change", ATTRS{name}=="DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"
EOF
  fi

  if ! [[ -f "$via92" ]]; then
    sudo tee "$via92" > /dev/null <<'EOF'
KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0666", TAG+="uaccess", TAG+="udev-acl"
EOF
  fi

  sudo chmod 0644 "$snack99" "$dualctl98" "$ignoreTouch99" "$via92"

}

set_udev
sudo udevadm control --reload-rules
sudo udevadm trigger

{{ end -}}
