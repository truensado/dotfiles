#!/usr/bin/env bash

{{- if .personal }}

keyPath="{{ .chezmoi.config.age.identity }}"

sudo -v

check_install() {
  local cmd="$1"
  local pkg="$2"
  
  if ! command -v "$cmd" &>/dev/null; then
    echo -e "{{ .color.bold }}Info{{ .color.reset }}: {{ .color.info }}installing...{{ .color.reset }}$pkg"
    sudo pacman -S --needed --noconfirm "$pkg"
  fi

}

{{- if not (stat .chezmoi.config.age.identity) }}

set_ssh() {
  mkdir -p "$(dirname "$keyPath")"
  chmod 700 "$(dirname "$keyPath")"

  echo -e "{{ .color.bold }}getting ssh key{{ .color.reset }}"
  local privateKey publicKey

  privateKey="{{ (bitwarden "item" "main-ssh").sshKey.privateKey }}"
  publicKey="{{ (bitwarden "item" "main-ssh").sshKey.publicKey }}"

  printf '%b' "$privateKey" > "$keyPath" && chmod 600 "$keyPath"
  printf '%b' "$publicKey" > "${keyPath}.pub" && chmod 644 "${keyPath}.pub"

}

{{- else }}

set_ssh() {
  mkdir -p "$(dirname "$keyPath")"
  chmod 700 "$(dirname "$keyPath")"

  echo -e "{{ .color.success }}ssh key already exists{{ .color.reset }}"
}

{{- end }}

set_gpg() {
  if ! gpg --list-secret-keys --with-colons | grep -q '^sec:'; then
    echo -e "generating gpg key"
    gpg --full-generate-key
  else
    echo -e "{{ .color.success }}gpg key already exists{{ .color.reset }}"
  fi
}

check_install gpg gnupg
check_install ssh openssh

set_gpg
set_ssh

{{ end -}}
