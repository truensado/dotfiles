#!/usr/bin/env bash

scrDir="{{ .chezmoi.sourceDir }}/.chezmoiscripts/lib"
source "${scrDir}/run_vars.sh"

write_udev_rule() {
  local path="$1"
  local content="$2"

  if [[ ! -f "$path" ]]; then
    log_info "setting up udev rule at $(basename "$path")..."
    echo "$content" | sudo tee "$path" > /dev/null
    return 0
  fi
  return 1
}

set_udev() {
  local installed=0

  declare -A rules=(
    ["99-snackbox-controllers.rules"]=$'# udev rules for Snackbox Micro (Zeroplus-based)\nKERNEL=="hidraw*", ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox", MODE="0660", TAG+="uaccess"\n\nKERNEL=="event*", ATTRS{idVendor}=="0c12", ATTRS{idProduct}=="0ef7", SYMLINK+="input/snackbox-event", MODE="0660", TAG+="uaccess"'
    ["98-dualsensectl.rules"]=$'# PS5 DualSense controller rules\nKERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0ce6", MODE="0660", TAG+="uaccess"\n\n# Ps5 Dualsence controller over bluetooth hidraw\nKERNEL=="hidraw*", KERNELS=="*054C:0CE6*", MODE="0660", TAG+="uaccess"\n\n# Ps5 Dualsense Edge controller over USB hidraw\nKERNEL=="hidraw*", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0df2", MODE="0660", TAG+="uaccess"\n\n# Ps5 Dualsense Edge Controller over bluetooth hidraw\nKERNEL=="hidraw*", KERNELS=="*054C:0DF2*", MODE="0660", TAG+="uaccess"'
    ["99-ignore-ds5-touchpad.rules"]=$'# DualSense Touchpad Ignore\nACTION=="add|change", ATTRS{name}=="Sony Interactive Entertainment DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"\n\n# BT touchpad ignore\nACTION=="add|change", ATTRS{name}=="DualSense Wireless Controller Touchpad", ENV{LIBINPUT_IGNORE_DEVICE}="1"'
    ["92-viia.rules"]=$'KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0666", TAG+="uaccess", TAG+="udev-acl"'
  )

  for filename in "${!rules[@]}"; do
    if write_udev_rule "$udev_path/$filename" "${rules[$filename]}"; then
      installed=1
    fi
  done

  if [[ "$installed" -eq 1 ]]; then
    log_info "finishing udev rules"
    sudo chmod 0644 "${udev_path}"/*.rules
    sudo udevadm control --reload-rules
    sudo udevadm trigger
  elif [[ "$installed" -eq 0 ]]; then
    log_info "udev rules already set up"
  fi
}

main() {
  udev_path="/etc/udev/rules.d"
  [[ -d "$udev_path" ]] || sudo install -d -m 0755 "$udev_path"
  set_udev
}

main
